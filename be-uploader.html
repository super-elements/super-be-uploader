<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
@license
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <be-uploader></be-uploader>

Example:

    <be-uploader>
      <h2>Hello be-uploader</h2>
    </be-uploader>

@demo demo/index.html
@hero hero.svg
-->
<dom-module id="be-uploader">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      .inputfiles {
        visibility: hidden;
      }

    </style>
    <content></content>
    <input type="file" name="image" id="addinputfiles" class="inputfiles"  multiple="{{multiple}}" accept="{{accept}}">
  </template>

  <script>
    var filearray = [];
    Polymer({
      is: 'be-uploader',
      properties: {

        files: {
          type: Array,
          value: []
        },

        value: {
          type: Array,
          value: [],
          observer: '_valueChanged'
        },

        accept: {
          type: String,
          value: ''
        },

        multiple: {
          type: Boolean,
          notify: false
        },
    },

    _createPreviews: function () {
      var self = this;
      function findkey(key,str,filearr){
        for(var k=0; k < filearr.length; k++){
          if(filearr[k][key] == str){
            return filearr[k]
          }
        }
      }
      self.querySelector('[preview]').innerHTML = '';
      for(var valueindex = 0; valueindex < this.value.length; valueindex++){
        // The image has been uploaded a new
        if(this.value[valueindex].indexOf("://") == -1){
          var fileObject = findkey('name',this.value[valueindex],filearray)
          // In fileObject we get the matched filename from this.value and this.file
          if (fileObject){(
            function (fileObject){
              var reader = new FileReader();
              if((fileObject.type == 'image/jpg')||(fileObject.type == 'image/png')||(fileObject.type == 'image/jpeg')) {
                reader.onload = function() {
                  // To create img tag
                  var image = document.createElement('img');
                  image.src = reader.result;
                  self.querySelector('[preview]').appendChild(image);
                }
                reader.readAsDataURL(fileObject);
              }
              else if((fileObject.type == 'video/mp4')||(fileObject.type == 'video/3gp')||(fileObject.type == 'video/avi')) {
                reader.onload = function() {
                  // To create video Tag
                  var vid = document.createElement('video');
                  vid.controls = true;
                  vid.src = reader.result;
                  self.querySelector('[preview]').appendChild(vid);
                }
                reader.readAsDataURL(fileObject);
              }
              else {
                // TODO Write better error handling as well as error handling for
                // things already defined in this.value
                throw (new Error('Error! Unknown file type for ' + fileObject.name));
              }
            })(fileObject);
          }
        }
        //Image is in the uploader's `value` property but not uploaded now by the user.
        else {
          var fileExtension = self.value[valueindex].split('.').pop();
          if((fileExtension == 'jpg')||(fileExtension == 'JPG')||(fileExtension == 'jpeg')||(fileExtension == 'png')) {
            // create img tag
            var image = document.createElement('img');
            image.src = self.value[valueindex];
            self.querySelector('[preview]').appendChild(image);
          } else if((fileExtension == 'mp4')||(fileExtension == 'avi')||(fileExtension == '3gp')) {
            var vid = document.createElement('video');
            vid.controls = true;
            vid.src = self.value[valueindex];
            self.querySelector('[preview]').appendChild(image);
          }
          // else {
          //   // TODO Write better error handling as well as error handling for
          //   // things already defined in this.value
          //   throw (new Error('Unknown File Extension'));
          // }
        }
      }
    },

    _valueChanged: function(newValue, oldValue) {
      this._createPreviews();
    },
    ready: function() {
      var self = this;
      self._createPreviews();
      this.querySelector('[uploader]').addEventListener("click", function() {
        self.$.addinputfiles.click(function(self) {});
      });
      this.$.addinputfiles.addEventListener("change", function(){
        self.fire("change");
        for ( var i = 0; i < self.$.addinputfiles.files.length; i++){
          filearray.push( self.$.addinputfiles.files[i]);
          self.files.push(self.$.addinputfiles.files);
        }
        for(var j = 0; j < self.$.addinputfiles.files.length; j++){
          self.value.push(self.$.addinputfiles.files[j].name);
        }
        self._createPreviews();
      });
    },
    attached: function() {
    },

    detached: function() {
    },
    });
  </script>
</dom-module>
